<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Stress Level Predictor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f4f7fb; }
    .card { border-radius:12px; }
    #predictionResult { font-size:1.25rem; font-weight:600; }
  </style>
</head>
<body>
  <div class="container mt-5">
    <h1 class="text-center mb-4">Stress Level Predictor</h1>
    <div class="row">
      <div class="col-md-8 offset-md-2">
        <form id="predictionForm" class="p-4 card shadow-sm bg-white">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="age" class="form-label">Age Group</label>
              <select class="form-select" id="age" name="age" required>
                {% for age in mappings.age.keys() %}
                  <option value="{{ age }}">{{ age }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6 mb-3">
              <label for="gender" class="form-label">Gender</label>
              <select class="form-select" id="gender" name="gender" required>
                {% for gender in mappings.gender.keys() %}
                  <option value="{{ gender }}">{{ gender }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="work_hours" class="form-label">Work Hours</label>
              <select class="form-select" id="work_hours" name="work_hours" required>
                {% for hours in mappings.work_hours.keys() %}
                  <option value="{{ hours }}">{{ hours }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6 mb-3">
              <label for="screen_time" class="form-label">Screen Time</label>
              <select class="form-select" id="screen_time" name="screen_time" required>
                {% for time in mappings.screen_time.keys() %}
                  <option value="{{ time }}">{{ time }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="sleep_time" class="form-label">Sleep Time</label>
              <select class="form-select" id="sleep_time" name="sleep_time" required>
                {% for time in mappings.sleep_time.keys() %}
                  <option value="{{ time }}">{{ time }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6 mb-3">
              <label for="exercise_freq" class="form-label">Exercise Frequency</label>
              <select class="form-select" id="exercise_freq" name="exercise_freq" required>
                {% for freq in mappings.exercise_freq.keys() %}
                  <option value="{{ freq }}">{{ freq }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="mood" class="form-label">Mood Stability</label>
              <select class="form-select" id="mood" name="mood" required>
                {% for mood in mappings.mood.keys() %}
                  <option value="{{ mood }}">{{ mood }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6 mb-3">
              <label for="fatigue" class="form-label">Fatigue Level</label>
              <select class="form-select" id="fatigue" name="fatigue" required>
                {% for level in mappings.fatigue.keys() %}
                  <option value="{{ level }}">{{ level }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="headache" class="form-label">Headache Frequency</label>
              <select class="form-select" id="headache" name="headache" required>
                {% for freq in mappings.headache.keys() %}
                  <option value="{{ freq }}">{{ freq }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-4 mb-3">
              <label for="work_life_balance" class="form-label">Work-Life Balance</label>
              <select class="form-select" id="work_life_balance" name="work_life_balance" required>
                {% for balance in mappings.work_life_balance.keys() %}
                  <option value="{{ balance }}">{{ balance }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-4 mb-3">
              <label for="social_support" class="form-label">Social Support</label>
              <select class="form-select" id="social_support" name="social_support" required>
                {% for support in mappings.social_support.keys() %}
                  <option value="{{ support }}">{{ support }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <button type="submit" class="btn btn-primary w-100">Predict Stress Level</button>
        </form>

        <div id="result" class="mt-4 p-4 card shadow-sm bg-white" style="display:none;">
          <h3 class="text-center mb-3">Prediction Result</h3>
          <div id="predictionResult" class="text-center mb-4"></div>

          <div class="row">
            <div class="col-md-6 mb-4">
              <h5 class="text-center mb-3">Top Contributing Factors</h5>
              <canvas id="featureChart" style="max-height:300px;"></canvas>
            </div>
            <div class="col-md-6 mb-4">
              <h5 class="text-center mb-3">Personalized Recommendations</h5>
              <div id="recommendations"></div>
            </div>
          </div>
        </div>

        <div id="errorToast" class="toast align-items-center text-white bg-danger border-0 position-fixed bottom-0 end-0 m-3" role="alert" aria-live="assertive" aria-atomic="true" style="display:none;">
          <div class="d-flex">
            <div class="toast-body" id="errorText"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="document.getElementById('errorToast').style.display='none'"></button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // Keep chart instance global so we can destroy it before re-creating
    let featureChart = null;

    document.getElementById('predictionForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      // Collect form values
      const form = e.target;
      const formData = {
        age: form.age.value,
        gender: form.gender.value,
        work_hours: form.work_hours.value,
        screen_time: form.screen_time.value,
        sleep_time: form.sleep_time.value,
        exercise_freq: form.exercise_freq.value,
        mood: form.mood.value,
        fatigue: form.fatigue.value,
        headache: form.headache.value,
        work_life_balance: form.work_life_balance.value,
        social_support: form.social_support.value
      };

      // Show loading state
      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Predicting...';

      try {
        const res = await fetch('/predict', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });

        const data = await res.json();

        if (!res.ok) {
          // Show detailed error
          showError(data.error || 'Server returned an error');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Predict Stress Level';
          return;
        }

        // Display prediction
        document.getElementById('result').style.display = 'block';
        document.getElementById('predictionResult').textContent = data.prediction || 'No prediction';

        // Recommendations
        const recDiv = document.getElementById('recommendations');
        recDiv.innerHTML = '';
        if (Array.isArray(data.recommendations)) {
          const ul = document.createElement('ul');
          data.recommendations.forEach(r => {
            const li = document.createElement('li'); li.textContent = r; ul.appendChild(li);
          });
          recDiv.appendChild(ul);
        } else if (data.recommendations) {
          recDiv.textContent = data.recommendations;
        } else {
          recDiv.textContent = 'No recommendations available.';
        }

        // Feature importance chart (optional)
        if (data.feature_importance) {
          const ctx = document.getElementById('featureChart').getContext('2d');

          // convert object to arrays sorted by importance
          const entries = Object.entries(data.feature_importance).sort((a,b)=>b[1]-a[1]);
          const labels = entries.map(e=>e[0].replace(/_Code$/,'').replace(/_/g,' '));
          const values = entries.map(e=>e[1]);

          if (featureChart) featureChart.destroy();

          featureChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: labels.slice(0,6),
              datasets: [{ label: 'Importance', data: values.slice(0,6) }]
            },
            options: {
              responsive: true,
              plugins: { legend: { display: false } }
            }
          });
        } else {
          // clear chart area if none
          if (featureChart) { featureChart.destroy(); featureChart = null; }
          document.getElementById('featureChart').getContext('2d').clearRect(0,0,500,300);
        }

      } catch (err) {
        console.error('Fetch error:', err);
        showError(err.message || 'Unexpected error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Predict Stress Level';
      }
    });

    function showError(msg) {
      document.getElementById('errorText').textContent = msg;
      document.getElementById('errorToast').style.display = 'block';
    }
  </script>
</body>
</html>